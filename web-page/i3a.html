<!DOCTYPE html>
<html  lang="en">
    <head>
        <meta charset="utf-8">
		<title>Demo chart</title>
        <style>
        body {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
			background-image: url("charts.png");
			background-color: #cccccc;
			background-repeat: no-repeat;
        }

        .graph .axis {
            stroke-width: 2;
        }

        .graph .axis .tick line {
            stroke: black;
        }

        .graph .axis .tick text {
            fill: black;
            font-size: 0.8em;
        }

        .graph .axis .domain {
            fill: none;
            stroke: black;
        }

        .graph .group {
            fill: none;
            stroke: black;
            stroke-width: 1.5;
        }
		.grid .tick {
			stroke: lightgrey;
			opacity: 0.7;
		}
		.grid path {
			  stroke-width: 0;
		}
		#tempVal{
			background-color: white;
			position: absolute; 
			left: 698px;
			top: 234px;
			width: 57px;
			height: 27px;
		}
		#dewVal{
			background-color: white;
			position: absolute; 
			left: 698px;
			top: 321px;
			width: 57px;
			height: 27px;
		}
		#humidityVal{
			background-color: white;
			position: absolute; 
			left: 698px;
			top: 502px;
			width: 57px;
			height: 27px;
		}
		.values{
			font-size:1.5em;
		}
        </style>
    </head>
    <body>
        <div class="graph" style="position: absolute; left: 155px; top: 205px;"></div>
		<div id=tempVal class="values"></div>
		<div id=dewVal class="values"></div>
		<div id=humidityVal class="values"></div>

        <script src="http://d3js.org/d3.v3.min.js"></script>
		<script src="jquery.js"></script>
	    <script src="ws_data.js"></script>
        <script>
		var onMassageArray = new Array();
		var dewPointArray = new Array();;
		var stateFromQuery = "";
		var tempVal = 0;
		var dewVal = 0;
        var limit = 60 * 1,
            duration = 750,
            now = new Date(Date.now() - duration)

        var width = 485,
            height = 200

        var groups = {
            temperature: {
                value: 0,
                color: '#C80000',
                data: d3.range(limit).map(function() {
                    return 0
                })
            },
			dewPoint: {
                value: 0,
                color: '#0093C8',
                data: d3.range(limit).map(function() {
                    return 0
                })
            },
			humadity: {
                value: 0,
                color: '#00AA61',
                data: d3.range(limit).map(function() {
                    return 0
                })
            }
        }
		
		function make_x_axis() {        
			return d3.svg.axis()
				.scale(x)
				 .orient("bottom")
				 .ticks(5)
		}

		function make_y_axis() {        
			return d3.svg.axis()
				.scale(y)
				.orient("left")
				.ticks(9)
		}
        var x = d3.time.scale()
            .domain([now - (limit - 2), now - duration])
            .range([0, width])

        var y = d3.scale.linear()
            .domain([66, 86])
            .range([height+5, 6])

        var line = d3.svg.line()
            .interpolate('basis')
            .x(function(d, i) {
                return x(now - (limit - 1 - i) * duration)
            })
            .y(function(d) {
                return y(d)
            })

        var svg = d3.select('.graph').append('svg')
            .attr('class', 'chart')
            .attr('width', width)
            .attr('height', height)
		svg.append("rect")
			.attr("width", "100%")
			.attr("height", "100%")
			.attr("fill", "white");

		svg.append("g")         
			.attr("class", "grid")
			.call(make_y_axis()
				.tickSize(-width, 0, 0)
				.tickFormat("")
        )
		svg.append('g')
			.attr('class', 'y axis')
            .attr('transform', 'translate(0,0)')
            .call(y.axis = d3.svg.axis().scale(y).orient('right'))
		svg.append('g')
            .attr('class', 'x axis')
            .attr('transform', 'translate(0,' + (height) + ')')
            .call(x.axis = d3.svg.axis().scale(x).orient('bottom').ticks(0))

        var paths = svg.append('g')

        for (var name in groups) {
            var group = groups[name]
            group.path = paths.append('path')
                .data([group.data])
                .attr('class', name + ' group')
                .style('stroke', group.color)
        }
		
		function formatDecimal(decimal){
			return parseFloat(Math.round(decimal * 100) / 100).toFixed(2);
		}

        function tick() {
			$('#arrayDataSize').html(onMassageArray.length);//temp
			$('#dewPointVal').html(dewPointArray.length);//temp
			if(onMassageArray.length != 0){tempVal = onMassageArray.shift(); onMassageArray =[];};
			if(dewPointArray.length != 0){dewVal = dewPointArray.shift(); dewPointArray=[];};
			now = new Date()

				// Add new values
				for (var name in groups) {
					var group = groups[name];
					if(name == 'dewPoint'){
						group.data.push(dewVal);
						$('#dewVal').html(formatDecimal(dewVal));
					}else{
						group.data.push(tempVal);
						$('#tempVal').html(formatDecimal(tempVal));
					}	
					group.path.attr('d', line);
				}

				// Shift domain
				x.domain([now - (limit - 2) * duration, now - duration])

				// Slide paths left
				paths.attr('transform', null)
					.transition()
					.duration(duration)
					.ease('linear')
					.attr('transform', 'translate(' + x(now - (limit - 1) * duration) + ')')
					.each('end', tick)

				// Remove oldest data point from each group
				for (var name in groups) {
					var group = groups[name]
					group.data.shift()
				}
        }
		
		$(function() {
			var serachParams = window.location.search.substring(1);
			var query = window.location.search.substring(1);
			var vars = query.split("&");
			for (var i=0; i < vars.length; i++) {
				var pair = vars[i].split("=");
				if (pair[0] === "state") {
					stateFromQuery = decodeURIComponent(pair[1]);
				}
			}
		});
        </script>
    </body>
</html>