<!DOCTYPE html>
<html  lang="en">
    <head>
        <meta charset="utf-8">
		<title>Demo chart</title>
        <style>
        body {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        }

        .graph .axis {
            stroke-width: 1;
        }

        .graph .axis .tick line {
            stroke: black;
        }

        .graph .axis .tick text {
            fill: black;
            font-size: 0.7em;
        }

        .graph .axis .domain {
            fill: none;
            stroke: black;
        }

        .graph .group {
            fill: none;
            stroke: black;
            stroke-width: 1.5;
        }
        </style>
    </head>
    <body>
        <div class="graph"></div>

        <script src="http://d3js.org/d3.v3.min.js"></script>
		<script src="jquery.js"></script>
	    <script src="ws_data.js"></script>
        <script>
		var onMassageArray = new Array();
		var dewPointArray = new Array();;
		var stateFromQuery = "";
		var tempVal = 0;
		var dewVal = 0;
        var limit = 60 * 1,
            duration = 750,
            now = new Date(Date.now() - duration)

        var width = 500,
            height = 200

        var groups = {
            temperature: {
                value: 0,
                color: 'orange',
                data: d3.range(limit).map(function() {
                    return 0
                })
            },
			dewPoint: {
                value: 0,
                color: 'blue',
                data: d3.range(limit).map(function() {
                    return 0
                })
            }
        }

        var x = d3.time.scale()
            .domain([now - (limit - 2), now - duration])
            .range([0, width])

        var y = d3.scale.linear()
            .domain([5, 30])
            .range([height, 0])

        var line = d3.svg.line()
            .interpolate('basis')
            .x(function(d, i) {
                return x(now - (limit - 1 - i) * duration)
            })
            .y(function(d) {
                return y(d)
            })

        var svg = d3.select('.graph').append('svg')
            .attr('class', 'chart')
            .attr('width', width)
            .attr('height', height)

        //var axis = svg.append('g')
            //.attr('class', 'x axis')
            //.attr('transform', 'translate(20,' + (height+5) + ')')
            //.call(x.axis = d3.svg.axis().scale(x).orient('bottom').ticks(0))
		var axisY = svg.append('g')
			.attr('class', 'y axis')
            .attr('transform', 'translate(0,5)')
            .call(y.axis = d3.svg.axis().scale(y).orient('right'))

        var paths = svg.append('g')

        for (var name in groups) {
            var group = groups[name]
            group.path = paths.append('path')
                .data([group.data])
                .attr('class', name + ' group')
                .style('stroke', group.color)
        }

        function tick() {
			$('#arrayDataSize').html(onMassageArray.length);//temp
			$('#dewPointVal').html(dewPointArray.length);//temp
			if(onMassageArray.length != 0){tempVal = onMassageArray.shift()};
			if(dewPointArray.length != 0){dewVal = dewPointArray.shift()};
			now = new Date()

				// Add new values
				for (var name in groups) {
					var group = groups[name];
					if(name == 'dewPoint'){
						group.data.push(dewVal);
					}else{
						group.data.push(tempVal);
					}	
					group.path.attr('d', line);
				}

				// Shift domain
				x.domain([now - (limit - 2) * duration, now - duration])

				// Slide x-axis left
				//axis.transition()
					//.duration(duration)
					//.ease('linear')
					//.call(x.axis)

				// Slide paths left
				paths.attr('transform', null)
					.transition()
					.duration(duration)
					.ease('linear')
					.attr('transform', 'translate(' + x(now - (limit - 1) * duration) + ')')
					.each('end', tick)

				// Remove oldest data point from each group
				for (var name in groups) {
					var group = groups[name]
					group.data.shift()
				}
        }
		
		$(function() {
			var serachParams = window.location.search.substring(1);
			var query = window.location.search.substring(1);
			var vars = query.split("&");
			for (var i=0; i < vars.length; i++) {
				var pair = vars[i].split("=");
				if (pair[0] === "state") {
					stateFromQuery = decodeURIComponent(pair[1]);
				}
			}
		});
        </script>
		<button id="connectButton">Connect</button>
		<button id="disconnectButton">Disconnect</button>
    </body>
</html>